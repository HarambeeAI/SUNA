# Progress Log

## Learnings
(Patterns discovered during implementation)

- Database uses Basejump for account management (basejump.accounts, basejump.account_user)
- Migrations are SQL files in backend/supabase/migrations/ with timestamp naming (YYYYMMDDHHMMSS_description.sql)
- Use BEGIN/COMMIT for transactional migrations
- RLS policies use basejump.has_role_on_account() for permission checks
- TypeScript types defined in apps/mobile/api/types.ts and individual files in apps/frontend/src/lib/api/
- pnpm is required but not installed - use `npx pnpm install` to install deps, then `npx pnpm run lint`
- organization_role enum extends basejump's basic owner/member with: owner, admin, member, viewer
- Use public.has_org_role() and public.has_org_permission() for organization-level permission checks
- organization_members table tracks membership with additional metadata beyond basejump.account_user

---

## Iteration 1 - US-001: Add organizations table (first AC)
- What was implemented:
  - Created SQL migration 20260116215926_organizations_table.sql
  - Added organizations table with fields: id, name, slug, plan_tier, billing_status, account_id, stripe_customer_id, stripe_subscription_id, settings, created_at, updated_at
  - Created plan_tier enum (free, pro, enterprise)
  - Created billing_status enum (active, past_due, canceled, trialing, unpaid)
  - Added RLS policies for CRUD operations
  - Added helper functions: create_organization, get_organization, get_organization_by_slug, get_user_organizations
  - Added TypeScript types to apps/mobile/api/types.ts
  - Created apps/frontend/src/lib/api/organizations.ts with types and API functions
- Files changed:
  - backend/supabase/migrations/20260116215926_organizations_table.sql (new)
  - apps/mobile/api/types.ts (modified - added Organization types)
  - apps/frontend/src/lib/api/organizations.ts (new)
- Learnings for future iterations:
  - Organizations table links to basejump.accounts via account_id FK
  - Basejump already has billing_subscriptions table - organizations extends this with plan_tier
  - RLS patterns: use basejump.has_role_on_account() with optional role parameter
---

## Iteration 2 - US-001: Add organization_members table (second AC)
- What was implemented:
  - Created SQL migration 20260116220000_organization_members_table.sql
  - Added organization_members table with fields: id, org_id, user_id, role, invited_by, joined_at, metadata
  - Created organization_role enum (owner, admin, member, viewer) for granular RBAC
  - Added RLS policies for CRUD operations with role-based restrictions
  - Added helper functions: has_org_role, has_org_permission, get_org_role, add_org_member, get_org_members, update_org_member_role, remove_org_member
  - Updated create_organization to also add creator as owner in organization_members
  - Added TypeScript types: OrganizationRole, OrganizationMember, AddOrganizationMemberRequest, UpdateOrganizationMemberRoleRequest
  - Added API functions: getOrganizationMembers, addOrganizationMember, updateOrganizationMemberRole, removeOrganizationMember
- Files changed:
  - backend/supabase/migrations/20260116220000_organization_members_table.sql (new)
  - apps/mobile/api/types.ts (modified - added OrganizationMember types)
  - apps/frontend/src/lib/api/organizations.ts (modified - added member management types and API functions)
  - PRD.md (marked second AC as complete)
- Learnings for future iterations:
  - organization_members provides more granular roles than basejump's basic owner/member
  - Use has_org_permission() for hierarchical permission checks (owner > admin > member > viewer)
  - Self-removal (leave org) is allowed except for last owner
  - Admins can manage members/viewers but not owners/other admins
---

## Iteration 3 - US-001: Add org_id to threads, agents, agent_runs (third AC)
- What was implemented:
  - Created SQL migration 20260116220100_add_org_id_to_tables.sql
  - Added org_id column (nullable FK to organizations) to threads, agents, and agent_runs tables
  - Created indexes for org_id columns
  - Updated RLS policies for all three tables to support organization-based access
  - Added helper functions: get_org_threads, get_org_agents, get_org_agent_runs
  - Updated TypeScript types to include org_id field
- Files changed:
  - backend/supabase/migrations/20260116220100_add_org_id_to_tables.sql (new)
  - apps/mobile/api/types.ts (modified - added org_id to Thread, Agent, AgentRun)
  - apps/frontend/src/lib/api/threads.ts (modified - added org_id to Thread)
  - apps/frontend/src/lib/api/agents.ts (modified - added org_id to AgentRun)
  - apps/frontend/src/hooks/agents/utils.ts (modified - added org_id to Agent)
  - PRD.md (marked third AC as complete)
- Learnings for future iterations:
  - org_id is nullable to support personal workspace resources (account_id) alongside organization resources
  - RLS policies now check both account_id and org_id for access control
  - Use has_org_permission() for organization-level checks in RLS policies
  - Thread/agent/run access now supports: personal workspace (via account_id), organization (via org_id), and project-based access
---

## Iteration 4 - US-001: Finalize schema migration (AC 4-6)
- What was implemented:
  - Verified all migration files are in place:
    - 20260116215926_organizations_table.sql
    - 20260116220000_organization_members_table.sql
    - 20260116220100_add_org_id_to_tables.sql
  - Verified RLS policies exist for all tables: organizations, organization_members, threads, agents, agent_runs
  - Verified lint/typecheck passes
- Files changed:
  - PRD.md (marked AC 4-6 as complete, US-001 is now fully complete)
- Learnings for future iterations:
  - Migration files are created as part of implementing the schema changes
  - RLS policies are added in the same migration as the table/column changes
  - US-001 is now complete with full multi-tenant database schema
---

## Iteration 5 - US-002: Organization creation and management API
- What was implemented:
  - Created backend/core/organizations/ module with:
    - __init__.py - module definition
    - repo.py - database repository functions (create, get, update, list orgs and members)
    - api.py - FastAPI router with endpoints:
      - POST /v1/organizations - create new organization
      - GET /v1/organizations/{org_id} - get organization with member list
      - PATCH /v1/organizations/{org_id} - update organization (name/settings)
      - GET /v1/organizations - list user's organizations
  - Created backend/core/api_models/organizations.py with Pydantic models:
    - PlanTier, BillingStatus, OrganizationRole enums
    - OrganizationCreateRequest, OrganizationUpdateRequest
    - OrganizationResponse, OrganizationMemberResponse, OrganizationsListResponse
  - Updated backend/core/api_models/__init__.py to export organization models
  - Updated backend/api.py to include organizations_router
  - Role-based access control:
    - GET /organizations/:id - requires org membership
    - PATCH /organizations/:id - requires admin or owner role
    - Returns 403 for unauthorized access
- Files changed:
  - backend/core/organizations/__init__.py (new)
  - backend/core/organizations/repo.py (new)
  - backend/core/organizations/api.py (new)
  - backend/core/api_models/organizations.py (new)
  - backend/core/api_models/__init__.py (modified - exports org models)
  - backend/api.py (modified - includes organizations_router)
  - PRD.md (marked US-002 as complete)
- Learnings for future iterations:
  - Follow existing patterns: router in api.py, db functions in repo.py, models in api_models/
  - Use has_org_permission(user_id, org_id, min_role) for RBAC checks
  - Frontend API client already exists at apps/frontend/src/lib/api/organizations.ts
  - Use serialize_row/serialize_rows from db.py for consistent serialization
  - Use execute_one_read for read operations (supports read replicas)
  - Use execute_one with commit=True for writes
---

## Iteration 6 - US-003: Team member invitation system
- What was implemented:
  - Database migration 20260116220200_organization_invitations.sql:
    - Created invitation_status enum (pending, accepted, expired, revoked)
    - Created organization_invitations table with token, email, role, status, expires_at
    - Added RLS policies for invitation management
    - Added SQL helper functions: create_org_invitation, accept_org_invitation, revoke_org_invitation, get_org_invitations, get_invitation_by_token, expire_old_invitations
  - Pydantic API models (backend/core/api_models/invitations.py):
    - InvitationStatus enum
    - InvitationCreateRequest, InvitationResponse, InvitationsListResponse
    - InvitationPublicResponse, AcceptInvitationResponse
  - Repository functions (backend/core/organizations/invitations_repo.py):
    - create_invitation, get_invitation_by_id, get_invitation_by_token
    - get_organization_invitations, get_pending_invitations_for_email
    - update_invitation_status, accept_invitation, check_existing_member
    - get_user_email, expire_old_invitations
  - API endpoints (backend/core/organizations/invitations_api.py):
    - POST /v1/organizations/{org_id}/invitations - create invitation
    - GET /v1/organizations/{org_id}/invitations - list invitations
    - GET /v1/invitations/{token} - get invitation details (public)
    - POST /v1/invitations/{token}/accept - accept invitation
    - DELETE /v1/organizations/{org_id}/invitations/{invitation_id} - revoke
  - Registered invitations_router in backend/api.py
- Files changed:
  - backend/supabase/migrations/20260116220200_organization_invitations.sql (new)
  - backend/core/api_models/invitations.py (new)
  - backend/core/api_models/__init__.py (modified - exports invitation models)
  - backend/core/organizations/invitations_repo.py (new)
  - backend/core/organizations/invitations_api.py (new)
  - backend/core/organizations/__init__.py (modified - exports invitations_repo)
  - backend/api.py (modified - includes invitations_router)
  - PRD.md (marked US-003 as complete)
- Learnings for future iterations:
  - Invitations use unique tokens (secrets.token_urlsafe) for accept/decline links
  - Invitations expire after 7 days by default
  - Public endpoint allows viewing invitation details before login
  - Email matching is case-insensitive (LOWER())
  - Existing pending invitations are expired when new one is created for same email/org
  - TODO: Email sending not implemented yet - will need email service integration
---

## Iteration 7 - US-004: Role-based access control (RBAC)
- What was implemented:
  - Created backend/core/organizations/rbac.py with comprehensive RBAC system:
    - OrganizationRole enum: owner, admin, member, viewer
    - Permission enum with fine-grained permissions (21 total)
    - ROLE_PERMISSIONS mapping defines what each role can do
    - ROLE_HIERARCHY for permission level comparisons
    - OrgAccessContext dataclass returned by auth dependencies
    - FastAPI dependencies: require_org_owner, require_org_admin, require_org_member, require_org_viewer
    - require_org_permission() factory for specific permission checks
  - Updated backend/core/organizations/__init__.py to export RBAC components
  - Updated backend/core/organizations/api.py to use RBAC dependencies instead of inline checks
  - Updated backend/core/organizations/invitations_api.py to use RBAC dependencies
  - Role permissions are now enforced via middleware (FastAPI dependencies)
- Files changed:
  - backend/core/organizations/rbac.py (new)
  - backend/core/organizations/__init__.py (modified - exports RBAC components)
  - backend/core/organizations/api.py (modified - uses RBAC dependencies)
  - backend/core/organizations/invitations_api.py (modified - uses RBAC dependencies)
  - PRD.md (marked US-004 as complete)
- Learnings for future iterations:
  - Use OrgAccessContext from RBAC dependencies to get user_id, org_id, and role
  - Role hierarchy: owner (4) > admin (3) > member (2) > viewer (1)
  - require_org_admin includes owners; require_org_member includes admins and owners
  - For specific permission checks use require_org_permission(Permission.BILLING_MANAGE)
  - Admins have all permissions except: ORG_DELETE, BILLING_MANAGE
  - Members can create/manage own resources but cannot manage others' resources
  - Viewers are read-only (5 permissions: view org, members, agents, threads, settings)
---
